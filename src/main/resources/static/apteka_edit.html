<!DOCTYPE html>
<html>

<head>
    <title>edit</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/apteka_edit.css">
    <link rel="icon" href="/img/kfc.png">

</head>

<body>
    <div class="main">
        <div class="dish" id="dish"></div>
    </div>

    <script>
    async function loadDish() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        // Загружаем сам продукт
        const res = await fetch(`/api/v1/apteka/getById?id=${id}`);
        const dish = await res.json();

        // Загружаем категории
        const resCat = await fetch('/api/v1/categoryProduct');
        const categories = await resCat.json();

        // генерим список option для select
        const options = categories.map(cat =>
            `<option value="${cat.name}" ${cat.name === dish.category_name ? 'selected' : ''}>${cat.name}</option>`
        ).join('');

        const container = document.getElementById("dish");
        container.innerHTML = `
            <form id="editForm">
                <img class='dishimg' src='${dish.image_path}' alt='${dish.name}'>
                <input class="text" type="file" accept="image/*" name="image" id="image"> 
                <input class="text" type="text" name="name" id="name" value="${dish.name}">
                
                <select class="text" name="category" id="category">
                    ${options}
                </select>
                
                <textarea class="text" name="description" id="description">${dish.description}</textarea>
                <div class="button_and_price">
                    <label class="text" for="on_main">На главной странице:</label>
                    <input name="on_main" id="on_main" type="checkbox">
                    <br>
                    <input class="text" type="number" name="price" id="price" value="${dish.price}">
                    <button class="button" type="button" id="editBtn">Сохранить</button>
                    <button class="button" type="button" id="deleteBtn">Удалить</button>
                </div>
            </form> 
        `;

        // выставляем чекбокс
        document.getElementById('on_main').checked = dish.on_main === true;

        // КНОПКА "СОХРАНИТЬ"
        const editBtn = document.getElementById('editBtn');
        editBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('id', id);
            formData.append('name', document.getElementById('name').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('on_main', document.getElementById('on_main').checked);

            const fileInput = document.getElementById('image');
            if (fileInput.files.length > 0) {
                formData.append('image', fileInput.files[0]);
            }

            const response = await fetch('/api/v1/apteka/updateProduct', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Обновлено!');
                window.location.href = 'apteka_admin.html';
            } else {
                const errorText = await response.text();
                alert('Ошибка: ' + errorText);
            }
        });

        // КНОПКА "УДАЛИТЬ"
        const deleteBtn = document.getElementById('deleteBtn');
        deleteBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!confirm("Вы уверены, что хотите удалить товар?")) {
                return;
            }

            const response = await fetch(`/api/v1/apteka?id=${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert("Удалено!");
                window.location.href = 'apteka_admin.html';
            } else {
                const errorText = await response.text();
                alert("Ошибка: " + errorText);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", loadDish);
</script>

</body>

</html>